<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠÙŠÙ† â€“ HandyDZ</title>
<style>
body {font-family:'Cairo',sans-serif;background:#f8f8f8;margin:0;padding:0; overflow: hidden;}
header {background:#1E3A8A;color:white;text-align:center;padding:15px;font-size:1.5rem;}
.container {max-width:1100px;margin:20px auto;background:white;padding:20px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);overflow-x:auto;}
table {width:100%;border-collapse: collapse;margin-top:10px;}
th, td {padding:12px;border:1px solid #ccc;text-align:center;}
th {background:#1E3A8A;color:white;}
button {padding:6px 12px;margin:2px;border:none;border-radius:5px;cursor:pointer;color:white;}
.activate {background:#22C55E;}
.reject {background:#EF4444;}
.whatsapp {background:#25D366;}
.filter-btn {background:#3B82F6;margin-right:5px;}
.active-status {color:#22C55E;font-weight:bold;}
.expired-status {color:#EF4444;font-weight:bold;}
.rejected-status {color:#888;font-weight:bold;}
.pending-status {color:#F59E0B;font-weight:bold;}
#authScreen {
  position: fixed; top:0; left:0; width:100%; height:100%;
  background: #1E3A8A; color: white; display: flex;
  flex-direction: column; justify-content: center; align-items: center;
  z-index: 9999;
}
#authScreen input {
  padding: 10px; margin: 10px; width: 250px; border-radius: 5px; border: none;
}
#authScreen button {
  background: #3B82F6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;
}
</style>
</head>
<body>

<div id="authScreen">
  <h2>ğŸ”’ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© â€“ HandyDZ</h2>
  <input type="password" id="passwordInput" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="off">
  <button onclick="verifyPassword()">Ø¯Ø®ÙˆÙ„</button>
  <p id="authMessage" style="color: #ffcc00; margin-top: 10px;"></p>
</div>

<header>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠÙŠÙ† â€“ HandyDZ</header>

<div class="container" id="mainContent" style="display:none;">
  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ÙÙ„ØªØ±Ø© + Ø²Ø± Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
  <div>
    <button class="filter-btn" onclick="setFilter('all')">Ø§Ù„ÙƒÙ„</button>
    <button class="filter-btn" onclick="setFilter('pending')">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
    <button class="filter-btn" onclick="setFilter('active')">Ù†Ø´Ø·</button>
    <button class="filter-btn" onclick="setFilter('expired')">Ù…Ù†ØªÙ‡Ù</button>
    <button class="filter-btn" onclick="setFilter('rejected')">Ù…Ø±ÙÙˆØ¶</button>
    <button class="filter-btn" style="background:#F59E0B;" onclick="goToCustomers()">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ù…Ù‡Ù†Ø©</th><th>Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</th><th>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</th>
        <th>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="prosTable"></tbody>
  </table>
</div>

<script>
/* ===== Ø¯ÙˆØ§Ù„ ØªØ´ÙÙŠØ± Ø¢Ù…Ù†Ø© ===== */
async function deriveKey(password, salt) {
  const enc = new TextEncoder();
  const keyMaterial = await window.crypto.subtle.importKey(
    "raw",
    enc.encode(password),
    { name: "PBKDF2" },
    false,
    ["deriveBits", "deriveKey"]
  );
  return await window.crypto.subtle.deriveKey(
    { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
    keyMaterial,
    { name: "AES-GCM", length: 256 },
    true,
    ["encrypt", "decrypt"]
  );
}

async function hashPassword(password) {
  const salt = window.crypto.getRandomValues(new Uint8Array(16));
  const key = await deriveKey(password, salt);
  const exported = await window.crypto.subtle.exportKey("raw", key);
  const hash = Array.from(new Uint8Array(exported)).map(b => b.toString(16).padStart(2, '0')).join('');
  return { salt: Array.from(salt), hash };
}

async function verifyHash(password, stored) {
  const salt = new Uint8Array(stored.salt);
  const key = await deriveKey(password, salt);
  const exported = await window.crypto.subtle.exportKey("raw", key);
  const hash = Array.from(new Uint8Array(exported)).map(b => b.toString(16).padStart(2, '0')).join('');
  return hash === stored.hash;
}

/* ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ===== */
async function verifyPassword() {
  const input = document.getElementById("passwordInput").value;
  if (!input) return;

  const stored = localStorage.getItem("admin_auth");
  let valid = false;

  if (!stored) {
    // Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±
    const confirm = prompt("ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
    if (input !== confirm) {
      showMessage("ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†!", "error");
      return;
    }
    const auth = await hashPassword(input);
    localStorage.setItem("admin_auth", JSON.stringify(auth));
    valid = true;
  } else {
    valid = await verifyHash(input, JSON.parse(stored));
  }

  if (valid) {
    sessionStorage.setItem("admin_ok", "true");
    document.getElementById("authScreen").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    startSessionTimeout();
    loadProfessionals();
  } else {
    showMessage("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!", "error");
  }
}

function showMessage(text, type = "info") {
  const msg = document.getElementById("authMessage");
  msg.textContent = text;
  msg.style.color = type === "error" ? "#ff6b6b" : "#a0d2eb";
  setTimeout(() => msg.textContent = "", 3000);
}

/* ===== Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø¹Ø¯ 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø¹Ø¯Ù… Ù†Ø´Ø§Ø· ===== */
let sessionTimeout;
function startSessionTimeout() {
  clearTimeout(sessionTimeout);
  sessionTimeout = setTimeout(() => {
    alert("ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø¬Ù„Ø³ØªÙƒ Ø¨Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù†Ø´Ø§Ø·.");
    sessionStorage.removeItem("admin_ok");
    location.reload();
  }, 15 * 60 * 1000); // 15 Ø¯Ù‚ÙŠÙ‚Ø©

  // ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ Ø£ÙŠ ØªÙØ§Ø¹Ù„
  ['click', 'keypress', 'scroll'].forEach(event => {
    document.addEventListener(event, () => startSessionTimeout(), { passive: true });
  });
}

/* ===== Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙƒÙ…Ø§ Ù‡ÙŠ (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± ÙƒØ¨ÙŠØ±) ===== */
function normalizePhone(raw){
  const digits = (raw || '').replace(/\D/g,'');
  if(!digits) return '';
  if(digits.startsWith('0')) return '213' + digits.slice(1);
  if(digits.startsWith('213')) return digits;
  if(digits.length === 8) return '213' + digits;
  return digits;
}

// ... (Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„: goToCustomers, setFilter, loadProfessionals, activateByPhone, rejectByPhone, sendWhatsAppByPhone, sendExpiryMessage)

// Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø©
window.addEventListener("load", () => {
  if (sessionStorage.getItem("admin_ok") === "true") {
    document.getElementById("authScreen").style.display = "none";
    document.getElementById("mainContent").style.display = "block";
    startSessionTimeout();
    loadProfessionals();
  }
});

// ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©
setInterval(() => {
  if (sessionStorage.getItem("admin_ok") === "true") loadProfessionals();
}, 60000);

// === Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ù…Ø«Ù„ loadProfessionals) ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ ===
// (ÙŠÙ…ÙƒÙ†Ùƒ Ù„ØµÙ‚ Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù‡Ù†Ø§)
</script>

</body>
</html>